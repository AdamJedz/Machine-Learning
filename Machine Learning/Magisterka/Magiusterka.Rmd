---
title: "Magisterka"
author: "Igor Adamiec"
date: "2/5/2019"
output: html_document
---
```{r}
set.seed(123)
```

```{r}
library(tidyverse)
library(colorspace)
library(data.table)
library(gridExtra)
```

Unifikacja danych jakościowych:
- rankingu wiekowego widowni,
- gatunku filmu,
- języka filmu, 
- kraju pochodzenia filmu,

```{r}
dataset <- read_csv("magisterka.csv") %>% 
  select(-X1, -ID) %>% 
  rename("Audience" = "Rating.x",
         "RottenRating" = "Rating.y") %>% 
  mutate(Title = as.factor(Title),
         Audience = case_when(is.na(Audience) ~ "Not Rated",
                              Audience == "12" ~ "PG",
                              Audience == "12A" ~ "PG",
                              Audience == "13" ~ "PG-13",
                              Audience == "14" ~ "PG-13",
                              Audience == "15" ~ "PG-13",
                              Audience == "15A" ~ "PG-13",
                              Audience == "18" ~ "NC-17",
                              Audience == "6" ~ "G",
                              Audience == "AL" ~ "G",
                              Audience == "All" ~ "G",
                              Audience == "Approved" ~ "G",
                              Audience == "Atp" ~ "G",
                              Audience == "M" ~ "R",
                              Audience == "MA15+" ~ "R",
                              Audience == "PG13" ~ "PG-13",
                              Audience == "TV-14" ~ "PG-13",
                              Audience == "TV-G" ~ "G",
                              Audience == "TV-MA" ~ "R",
                              Audience == "TV-PG" ~ "PG",
                              Audience == "U" ~ "R",
                              Audience == "X" ~ "NC-17",
                              Audience == "Unrated" ~ "Not Rated",
                              TRUE ~ Audience),
         Audience = factor(Audience, levels = c("G", "PG", "PG-13", "R", "NC-17", "Not Rated")),
         Genre = gsub("\\,.*","",Genre),
         Genre = case_when(is.na(Genre) ~ "(Other)",
                              TRUE ~ Genre),
         Genre = as.factor(Genre),
         Language = case_when(is.na(Language) ~ "English",
                              TRUE ~ Language),
         Language = gsub("\\,.*","",Language),
         Language= as.factor(Language),
         Country = case_when(is.na(Country) ~ "USA", 
                             TRUE ~ Country),
         Country = gsub("\\,.*","",Country),
         Country = as.factor(Country),
         Director = as.factor(Director))
```
Wypełnianie braków danych w zmiennych ilościowych:
- oceny z serwisu Metacritic,
- Oceny z serwisu IMDB,
- Oceny użytkowników serwisu Rotten Tomatoes,
- oceny użytnkowników serwisu metacritic,
- ilosci pieniedzy, jakie zarobiłfilm w tzw. Box office

Oceny z Metacritica na podstawie mediany ocen dla tych samych gatunków, 7 filmów usunąłem (6 noir i jeden adult)

```{r}
for (i in dataset %>% filter(is.na(Metacritic)) %>% 
  count(Genre) %>% pull(Genre)) {
  
  dataset[is.na(dataset$Metacritic) & dataset$Genre == i, "Metacritic"] <- dataset %>% 
  filter(!is.na(Metacritic),
         Genre == i) %>% 
  pull(Metacritic) %>% 
  median
  
}

dataset <- dataset[!is.na(dataset$Metacritic),]
```

Tak samo dla ocen z IMDB

```{r}
for (i in dataset %>% filter(is.na(imdbRating)) %>% 
  count(Genre) %>% pull(Genre)) {
  
  dataset[is.na(dataset$imdbRating) & dataset$Genre == i, "imdbRating"] <- dataset %>% 
  filter(!is.na(imdbRating),
         Genre == i) %>% 
  pull(imdbRating) %>% 
  median
  
}
```

```{r}
for (i in dataset %>% filter(is.na(userMeter)) %>% 
  count(Genre) %>% pull(Genre)) {
  
  dataset[is.na(dataset$userMeter) & dataset$Genre == i, "userMeter"] <- dataset %>% 
  filter(!is.na(userMeter),
         Genre == i) %>% 
  pull(userMeter) %>% 
  median
  
}
```

```{r}
for (i in dataset %>% filter(is.na(userRating)) %>% 
  count(Genre) %>% pull(Genre)) {
  
  dataset[is.na(dataset$userRating) & dataset$Genre == i, "userRating"] <- dataset %>% 
  filter(!is.na(userRating),
         Genre == i) %>% 
  pull(userRating) %>% 
  median
  
}
```


Dla Box office najpierw kombinacja Gatunek - kraj, potem sam kraj, a potem sam gatunek
```{r}
for (i in dataset %>% filter(is.na(BoxOffice)) %>% 
  count(Genre) %>% pull(Genre)) {
  
  for (j in dataset %>% filter(is.na(BoxOffice)) %>% 
  count(Country) %>% pull(Country)) {
    dataset[is.na(dataset$BoxOffice) & dataset$Genre == i & dataset$Country == j, "BoxOffice"] <- dataset %>% 
  filter(!is.na(BoxOffice),
         Genre == i,
         Country == j) %>% 
  pull(BoxOffice) %>% 
  median
  }
  
}

for (j in dataset %>% filter(is.na(BoxOffice)) %>% 
  count(Country) %>% pull(Country)) {
    dataset[is.na(dataset$BoxOffice) & dataset$Country == j, "BoxOffice"] <- dataset %>% 
  filter(!is.na(BoxOffice),
         Country == j) %>% 
  pull(BoxOffice) %>% 
  median
}

for (k in dataset %>% filter(is.na(BoxOffice)) %>% 
  count(Genre) %>% pull(Genre)) {
    dataset[is.na(dataset$BoxOffice) & dataset$Genre == k, "BoxOffice"] <- dataset %>% 
  filter(!is.na(BoxOffice),
         Genre == k) %>% 
  pull(BoxOffice) %>% 
  median
  }
```

```{r}
dataset %>% summary
```

# Podstawowe wykresy

```{r}
dataset %>% 
  ggplot() +
  geom_point(aes(x = userMeter, y = Metacritic, color = Genre)) +
  facet_wrap(Genre~.) +
  scale_color_manual(values = rainbow_hcl(22)) +
  theme(legend.position = "none")
```

```{r}
dataset %>% 
  ggplot() +
  geom_point(aes(x = imdbRating, y = Metacritic, color = Genre)) +
  facet_wrap(Genre~.) +
  scale_color_manual(values = rainbow_hcl(22)) +
  theme(legend.position = "none")
```

```{r}
library(colorspace)
```


```{r}
dataset %>% 
  ggplot() +
  geom_bar(aes(x = Audience, fill = Audience)) +
  scale_fill_manual(values = rainbow_hcl(6)) +
  labs(title = "Ilość filmów pod względem kategorii wiekowej",
       x = "Kategoria wiekowa",
       y = "Ilość filmów",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r}
dataset %>% 
  ggplot() +
  geom_bar(aes(x = Year), fill = "deepskyblue4") +
  labs(title = "Ilość filmów pod względem roku produkcji",
       y = "Ilość filmów",
       x = "Rok produkcji",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")
        
        )
```

```{r}
dataset %>% 
  ggplot() +
  geom_histogram(aes(x = Runtime), fill = "deepskyblue4", bins = 100) +
  labs(title = "Rozkład czasu trwania filmów",
       y = "Ilość filmów",
       x = "Czas trwania filmu (w minutach)",
       caption = "Źródło: opracowanie własne") +
  coord_cartesian(xlim =c(0, 250)) +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r}
dataset %>%
  count(Genre) %>% 
  arrange(desc(n)) %>% 
  head(8) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Genre, -n), y = n, fill = Genre)) +
  scale_fill_manual(values = rainbow_hcl(8)) +
  labs(title = "Najwięcej filmów pod względem gatunku",
       x = "Gatunek",
       y = "Ilość filmów",
       caption = "Źródło: opracowanie własne") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r}
dataset %>%
  count(Genre) %>% 
  arrange(desc(n)) %>% 
  tail(8) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Genre, n), y = n, fill = Genre)) +
  scale_fill_manual(values = rainbow_hcl(8)) +
  labs(title = "Najmnniej filmów pod względem gatunku",
       x = "Gatunek",
       y = "Ilość filmów",
       caption = "Źródło: opracowanie własne") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r}
dataset %>% 
  count(Director) %>% 
  arrange(desc(n)) %>%
  head(10) %>% 
  ggplot +
  geom_col(aes(x = reorder(Director, -n), y = n, fill = Director)) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Dziesięciu reżyserów z największą ilością filmów w zbiorze danych",
       x = "Reżyser",
       y = "Ilość filmów",caption = "Źródło: opracowanie własne")+
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = .5),
        axis.text.x = element_text(angle = 20),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```


```{r}
dataset %>%
  count(Language) %>% 
  arrange(desc(n)) %>% 
  head(8) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Language, -n), y = n, fill = Language)) +
  scale_fill_manual(values = rainbow_hcl(8)) +
  labs(title = "Najwięcej filmów pod względem języka",
       x = "Gatunek",
       y = "Język") +
  theme(legend.position = "none")
```

```{r}
dataset %>%
  count(Country) %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Country, -n), y = n, fill = Country)) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Najwięcej filmów pod względem kraju produkcji",
       x = "Kraj produkcji",
       y = "Ilość filmów",
       caption = "Źródło: opracowanie własne") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r fig.height=7, fig.width=7}
 plot_metacritic <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = Metacritic), fill = "goldenrod1", bins = 12) +
  labs(title = "Rozkład zmiennej Metacritic",
       y = "Ilość filmów",
      x = "Ocena na metacritic",
      caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  coord_cartesian(xlim = c(0, 100))

plot_imdb <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = imdbRating), fill = "gray18", bins = 20) +
  labs(title = "Rozkład zmiennej imdbRating",
       y = "Ilość filmów",
       x = "Srednia ocen na IMDB",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
grid.arrange(plot_metacritic, plot_imdb, ncol = 1)
```





```{r}
dataset %>% 
  count(Language) %>% 
  arrange(desc(n)) %>% 
  head(11) %>% 
  tail(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Language, -n), y = n, fill = Language)) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  labs(title = "Najpopularniejsze języki w filmach",
       subtitle = "Język angielski znajduje się na pierwszym miejscu z 10377 pozycjami.",
       x = "Język",
       y = "Ilość filmów",
       caption = "Źródło: opracowanie własne")
```



```{r fig.height=7, fig.width=7}
plot_rotten <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = RottenRating), fill = "forestgreen", bins = 15) +
  labs(title = "Rozkład zmiennej RottenRating",
       y = "Ilość filmów",
       x = "Ocena",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))

plot_meter <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = Meter), fill = "gold3", bins = 15) +
  labs(title = "Rozkład zmiennej Meter",
       y = "Ilość filmów",
       x = "Popularność wśród użytkowników Rotten Tomatoes",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust= .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
grid.arrange(plot_rotten, plot_meter, ncol = 1)
```



```{r fig.width= 7, fig.height=7}
plot_usermeter <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = userMeter), fill = "firebrick2", bins = 20) +
  labs(title = "Rozkład zmiennej userMeter",
       y = "Ilość filmów",
       x = "Ocena użytkowników portalu Rotten Tomatoes.",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust= .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))

ploterrating <- dataset %>% 
  ggplot() +
  geom_histogram(aes(x = userRating), fill = "goldenrod2", bins = 15) +
  labs(title = "Rozkład zmiennej userRating",
       y = "Ilość filmów",
       x = "Ocena użytkowników portalu Metacritic",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))

grid.arrange(plot_usermeter, ploterrating, ncol = 1)
```



```{r}
dataset %>% 
  arrange(desc(BoxOffice)) %>% 
  select(Title, BoxOffice)

dataset %>% 
  summarise(sum(Oscars))
```
```{r}
dataset %>% colnames
```

```{r}
dataset %>% 
  ggplot() +
  geom_point(aes(x = userMeter, y = userRating, color = imdbRating)) + 
  scale_color_gradient2(mid = "firebrick4", low = "darkgoldenrod1", high = "forestgreen", name = "IMDB:") +
  labs(title = "Porównanie ocen ze wszystkich trzech portali",
       subtitle = "Metacritic, Rotten Tomatoes i IMDB",
       x = "Oceny użytkowników Rotten Tomatoes",
       y = "Oceny użytkowników Metacritic",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        legend.background = element_rect(fill = "aliceblue"))
```
```{r}
dataset %>% 
  ggplot() +
  geom_point(aes(x = imdbRating, y = BoxOffice, color = ifelse(Oscars > 0, "Tak", "Nie")))+ 
  scale_color_manual(breaks = c("Tak", "Nie"),
                     labels = c("Tak", "Nie"),
                     name = "Oscar:",
                     values = c("gray55","goldenrod")) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Zależność wyniku finansowego od oceny z IMDB",
       subtitle = "Wartość wyniku finansowego przedstawiona jest w skali logarytmicznej",
       x = "Ocena z IMDB",
       y = "Wynik finansowy",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        legend.background = element_rect(fill = "aliceblue"))
```
```{r}
dataset %>% 
  ggplot() +
  geom_boxplot(aes(x = Genre, y = BoxOffice, fill = Genre)) +
  scale_y_log10(labels = scales::comma) +
  scale_fill_manual(values = rainbow_hcl(22)) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 30),
        plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  labs(title = "Zależność wyniku finansowego od gatunku filmu",
       subtitle = "Wartość wyniku finansowego przedstawiona jest w skali logarytmicznej",
       x = "Gatunek filmowy",
       y = "Wynik finansowy",
       caption = "Źródło: opracowanie własne")
```

```{r}
dataset %>% 
  ggplot(aes(x = ifelse(Oscars > 0, "Tak", "Nie"), y = BoxOffice, fill = ifelse(Oscars > 0, "Tak", "Nie"), color = ifelse(Oscars > 0, "Tak", "Nie")) ) +
  geom_boxplot(alpha = .8) +
  scale_y_log10(labels = scales::comma) +
  scale_color_manual(values = c("gray70","goldenrod")) +
  scale_fill_manual(values = c("dimgray","goldenrod")) +
  labs(title = "Zależność wygrania Oscara od wyniku finansowego",
       subtitle = "Wartość wyniku finansowego przedstawiona jest w skali logarytmicznej",
       x = "Czy film zdobył Oscara?",
       y = "Wynik finansowy",
       caption = "Źródło: opracowanie własne") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```


```{r}
dataset %>%
  ggplot() +
  geom_point(aes(x = userRating, y = Metacritic, color = ifelse(Oscars > 0, "Tak", "Nie"))) +
  facet_wrap(Genre~.) +
  scale_color_manual(breaks = c("Tak", "Nie"),
                     labels = c("Tak", "Nie"),
                     name = "Oscar:",
                     values = c("gray55","goldenrod")) +
  labs(title = "Wykres zależności ocen użytkowników od ocen recenzentów Metacritic",
       x = "Oceny użytkowników",
       y = "Oceny recenzentów",
       caption = "Źródło: obliczenia własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        legend.background = element_rect(fill = "aliceblue"))
```


```{r}
dataset %>%
  ggplot() +
  geom_point(aes(x = userMeter, y = RottenRating, color = ifelse(Oscars > 0, "Tak", "Nie"))) +
  facet_wrap(Genre~.) +
  scale_color_manual(breaks = c("Tak", "Nie"),
                     labels = c("Tak", "Nie"),
                     name = "Oscar:",
                     values = c("gray55","goldenrod")) +
  labs(title = "Wykres zależności ocen użytkowników od ocen recenzentów Rotten Tomatoes",
       x = "Oceny użytkowników",
       y = "Oceny recenzentów",
       caption = "Źródło: obliczenia własne") +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        legend.background = element_rect(fill = "aliceblue"))
```

```{r}
dataset %>% 
  filter(Genre == "Musical",
         Oscars != 0) %>% 
  select(Title)
```

```{r}
library(corrplot)
```
```{r}
col1 <- colorRampPalette(c("firebrick4", "white", "forestgreen"))
library(GGally)
```

```{r message = FALSE, fig.height= 30, fig.width=30}
dataset %>% 
  select_if(is.numeric) %>% ggpairs()
  
  cor(use = "complete.obs") %>% 
  corrplot.mixed(tl.pos = "lt",
                 order = "AOE",
           tl.srt = 45,
           lower.col = "black",
           number.cex = .7)
```
# Porównania Oscarowe 
```{r}
dataset %>% summarise(sum(Oscars))
```

```{r}
dataset %>% 
  mutate(Oscar_won = as.factor(ifelse(Oscars > 0, "Yes", "No"))) %>% 
  count(Oscar_won) %>% 
  ggplot() +
  geom_col(aes(x = Oscar_won, y = n), fill = c("gray55","goldenrod")) +
  geom_text(aes(x = Oscar_won, y = n, label = n), nudge_y = 400) +
  labs(title = "Porównanie filmów oscarowych z filmami nienagrodzonymi",
       y = "Ilość filmów",
       x = "Czy film został nagrodzony Oscarem?",
       caption = "Źródło: opracowanie własne") +
  scale_x_discrete(breaks = c("No", "Yes"), labels = c("Nie", "Tak")) +
  theme(plot.title = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
```

```{r}
oscar_data <- dataset %>% 
  filter(Oscars != 0)
```

```{r}
oscar_data %>% 
  group_by(Genre) %>% 
  summarize(sum = sum(Oscars)) %>% 
  arrange(desc(sum)) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Genre, -sum), y = sum, fill = Genre))+
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Dziesięć najczęściej nagradzanych gatunków filmowych",
       x = "Gatunek filmowy",
       y = "Ilość zdobytych Oscarów",
       caption = "Źródło: opracowanie własne")
```

```{r}
oscar_data %>% 
  group_by(Country) %>% 
  summarize(sum = sum(Oscars)) %>% 
  arrange(desc(sum)) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Country, -sum), y = sum, fill = Country))+
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Dziesięć najczęściej nagradzanych krajów",
       x = "Kraj produkcji",
       y = "Ilość zdobytych Oscarów",
       caption = "Źródło: opracowanie własne")
```

```{r}
oscar_data %>% 
  group_by(Language) %>% 
  summarize(sum = sum(Oscars)) %>% 
  arrange(desc(sum)) %>% 
  head(5) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Language, -sum), y = sum, fill = Language))+
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Pięć najczęściej nagradzanych języków",
       x = "Język filmu",
       y = "Ilość zdobytych Oscarów",
       caption = "Źródło: opracowanie własne")
```
```{r}
oscar_data %>% filter(Language == "Swedish", Oscars > 0)
```

```{r}
oscar_data %>% 
  group_by(Director) %>% 
  summarize(sum = sum(Oscars)) %>% 
  arrange(desc(sum)) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(Director, -sum), y = sum, fill = Director))+
  theme(plot.title = element_text(hjust = .5),
        legend.position = "none",
        axis.text.x = element_text(angle = 20, size = 11),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  scale_fill_manual(values = rainbow_hcl(10)) +
  labs(title = "Dziesięciu najczęściej nagradzanych reżyserów",
       x = "Reżyser",
       y = "Ilość zdobytych Oscarów",
       caption = "Źródło: opracowanie własne")
```

```{r}
oscar_data %>% 
  filter(Director == "William Wyler")
```


```{r}
dataset %>% 
  group_by(Year) %>% 
  summarize(sum = sum(Oscars)) %>% 
  filter(Year != 2014) %>% 
  ggplot(aes(x = Year, y = sum)) +
  geom_point(color = "goldenrod") +
  labs(title = "Coroczna ilość przyznawanych Oscarów",
       x = "Rok produkcji",
       y = "Łączna ilość przyznanych Oscarów",
       caption = "Źródło: opracowanie własne") +
  theme(
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        plot.title = element_text(hjust = .5))
```


# Wykresy alluvial

```{r}
library(alluvial)
```
```{r}
allu_data <- dataset %>% 
  filter(Language %in% c("English", "French", "Spanish", "Japanese", "Italian"),
         Country %in% c("USA", "UK", "France", "Canada", "Germany", "Italy", "Australia", "Japan")) %>% 
  mutate(
         Oscar_won = ifelse(Oscars >=1, "Yes", "No"),
         Oscar_won = as.factor(Oscar_won),
         Period = case_when(
           Year < 1930 ~ "< 1930",
           Year >= 1930 & Year < 1950 ~ "1930 - 1950",
           Year >= 1950 & Year < 1970 ~ "1950 - 1970",
           Year >= 1970 & Year < 1990 ~ "1970 - 1990",
           TRUE ~ "1990 +"
         ),
         Period = as.factor(Period),
         Time = case_when(
           Runtime < 60 ~ "Short",
           Runtime >= 60 & Runtime < 120 ~ "Normal",
           TRUE ~ "Long"
         ),
         Time = as.factor(Time)) %>% 
  select(Period, Audience, Genre, Time, Language, Country, Oscar_won)
```
```{r}
allu_data %>% glimpse
```
```{r}
library(ggalluvial)
```

```{r}
allu_data_periodTime <- allu_data %>% 
  count(Period, Time)  
  
allu_data_periodTime %>% 
  ggplot(aes(y = n,
         axis1 = Period, axis2 = Time)) +
  geom_alluvium(aes(fill = Period),
                width = 0, reverse = F) +
  guides(fill = F) +
  geom_stratum(width = 1/8, reverse = F) +
  geom_text(stat = "stratum", label.strata = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:2, labels = c("Rok produkcji", "Długość filmu")) +
  labs(title = "Długośc filmu w zależności od roku produkcji",
       subtitle = "Short - poniżej 60 min, Normal - 60 - 120 min, Long - powyżej 120 min",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
  
```

```{r}
top_genres <- dataset %>% count(Genre) %>% arrange(desc(n)) %>% tail(10) %>% mutate(Genre = as.character(Genre)) %>% pull(Genre)
allu_data_periodGenre <- allu_data %>% 
  filter(Genre %in% top_genres) %>% 
  count(Period, Genre)  
  
allu_data_periodGenre %>% 
  ggplot(aes(y = n,
         axis2 = Period, axis1 = Genre)) +
  geom_alluvium(aes(fill = Genre),
                width = 0, reverse = F) +
  guides(fill = F) +
  geom_stratum(width = 1/8, reverse = F) +
  geom_text(stat = "stratum", label.strata = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:2, labels = c("Gatunek", "Rok produkcji")) +
  labs(title = "Gatunek filmu w zależności od roku produkcji",
       subtitle = "Dla najmniej popularnych gatunków",
       caption = "Źródło: opracowanie własne") +
  theme(plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"))
  
```

```{r, error= FALSE}
allu_data_audience <- allu_data %>% 
  count(Audience, Oscar_won)  
  
# alluvial(allu_data_audience[,1:2], freq = allu_data_audience$n,
#          col = ifelse(allu_data_audience$Oscar_won == "Yes", "goldenrod", "gray55"),
#          border = ifelse(allu_data_audience$Oscar_won == "Yes", "goldenrod", "gray55"),
#          hide = allu_data_audience$n == 0,
#          cex = .7) +
#   scale_x_continuous(breaks = 1:2, labels = c("Kategoria Wiekowa", "Zdobycie nagrody")) +
#   labs(title = "Zależność kategorii wiekowej od faktu zdobycia Oscara",
#        caption = "Źródło: opracowanie własne") +
#   theme(plot.title = element_text(hjust = .5),
#         plot.subtitle = element_text(hjust = .5),
#         axis.title.y = element_blank(),
#         axis.text.y = element_blank(),
#         axis.ticks.y = element_blank())
```

#Zmienne jakościowe

```{r}
library(fastDummies)
library(data.table)
```

```{r}
dataset_model <- dataset %>% 
  select(-Title, -Director) %>% 
  dummy_cols(remove_most_frequent_dummy = T) %>%
  mutate(Oscar_won = ifelse(Oscars > 0, 1, 0),
         Oscar_won = as.factor(Oscar_won)) %>% 
  select(everything(), Oscar_won,-Oscars, -Language, -Country, -Genre, -Audience)
  
  
```
```{r}
dataset_model %>% filter(Language_Zulu == 1)
```


# Tworzenie modelu

```{r}
library(caTools)
library(caret)
```

Wyrzucanie zmiennych ze względu na zerową wariancje

Podział na zbiory

```{r}
split <- sample.split(dataset_model$Oscar_won, SplitRatio = .8)
training_set <- dataset_model %>% 
  subset(split == T)
test_set <- dataset_model %>% 
  subset(split == F)
```
```{r}
training_set %>% colnames() %>% length()
```

Normalizacja
```{r}
remove_zero_variance <- preProcess(training_set, method = c("zv", "nzv"))

training_set_nz <- predict(remove_zero_variance, training_set) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                                  starts_with("genre")), as.factor) 
test_set_nz <- predict(remove_zero_variance, test_set) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.factor) 
normalization <- preProcess(training_set_nz, method = c("center", "scale"))

training_norm <- predict(normalization, training_set_nz) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)
test_norm <- predict(normalization, test_set_nz) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)
```

```{r}
test_set_nz %>% colnames
```
```{r}
training_norm %>% select_if(is.numeric) %>% map_dfc(range)
```

Model ze wszystkimi zmiennymi
```{r}
classifier_1 <- glm(data = training_norm,
            formula = Oscar_won ~ .,
            family = binomial)
summary(classifier_1)
```

```{r}
exp(coef(classifier_1)) 
```

```{r}
srednia <- training_set$userRating %>% mean()
odchylenie <- training_set$userRating %>% sd()


odchylenie + srednia
```
```{r}
training_set$Meter[456]
```

```{r}
training_norm$Meter[1]
```

```{r}
training_norm$Meter[456]
```
```{r}
(min(training_norm$Meter)*odchylenie)+srednia
```
```{r}
min(training_set$userRating)
```

```{r}
library(ROCit)
```

```{r}
prob_train_1 <- predict(classifier_1, newdata = training_norm, type = "response")
```

```{r}
roc_train_1 <- rocit(score = prob_train_1, class = training_norm$Oscar_won)
plot(roc_train_1)
```

```{r}
roc_train_1 %>% summary
```
```{r}
sum(prob_train_1 > .269)
```

```{r}
pred_train_1 <- ifelse(prob_train_1 > .269, 1 , 0)
```

```{r}
cm_train_1 <- table(actual = training_norm %>% pull(Oscar_won), predicted = pred_train_1)
cm_train_1
```


```{r}
stats <- function(data) {
  
  accuracy <- round(sum(diag(data)) / sum(data),2)
  precision <- round(data[2, 2] / sum(data[, 2]), 2)
  recall <- round(data[2,2] / sum(data[2, ]), 2)
  f1 <- round(2*(precision * recall)/(precision + recall), 2)
  
  tibble(statistic = c("Accuracy", "Precision", "Recall", "F1 score"), results = c(accuracy, precision, recall, f1))
}
```

```{r}
stats_train_1 <- stats(cm_train_1)
stats_train_1
```


```{r}
prob_test_1 <- predict(classifier_1, newdata = test_norm, type = "response")
pred_test_1 <- ifelse(prob_test_1 >= .269, 1, 0)

```

```{r}
cm_test_1 <- table(actual = test_norm %>% pull(Oscar_won), predicted = pred_test_1)
cm_test_1
```

```{r}
stats_test_1 <- stats(cm_test_1)
stats_test_1
```






Selekcja zmiennych do modelu

```{r}
columns <- c()
for (i in 1:length(training_norm %>% colnames()) ) {
  ifelse(length(columns) > 0, zbior <- training_norm %>% 
    select(-columns), zbior <- training_norm)
  
  model <- glm(data = zbior,
               formula = Oscar_won ~.,
               family = binomial)
  podsumowanie <- summary(model)[[12]] %>% 
    as.data.frame() %>% 
    setDT(keep.rownames = T) %>% 
    arrange(desc(`Pr(>|z|)`)) %>%
    filter(rn != "(Intercept)") %>% 
    head(1)
  
  if (podsumowanie %>% pull(`Pr(>|z|)`) > 0.05) {
    zmienna <- podsumowanie %>% pull(rn) 
    zmienna <- gsub("`", "", zmienna)
    columns <- c(columns, zmienna)
  }
  
}
```

```{r}
training_norm %>% select(-columns) %>% colnames()
```

Model
```{r}
classifier_2 <- glm(data = training_norm %>% select(-columns),
            formula = Oscar_won ~ .,
            family = binomial)
summary(classifier_2)
```

```{r}
prob_train_2 <- predict(classifier_2, newdata = training_norm, type = "response")

```

```{r}
roc_train_2 <- rocit(score = prob_train_2, class = training_norm$Oscar_won)
plot(roc_train_2)
```

```{r}
roc_train_2 %>% summary()
```
```{r}
sum(prob_train_2 > .269)
```

```{r}
pred_train_2 <- ifelse(prob_train_2 >= .269, 1, 0)
```


```{r}
cm_train_2 <- table(actual = training_norm %>% pull(Oscar_won), predicted = pred_train_2)
cm_train_2
```

```{r}
stats_train_2 <- stats(cm_train_2)
stats_train_2
```


```{r}
prob_test_2 <- predict(classifier_2, newdata = test_norm, type = "response")
pred_test_2 <- ifelse(prob_test_2 >= .268, 1, 0)
```

```{r}
cm_test_2 <- table(actual = test_norm %>% pull(Oscar_won), predicted = pred_test_2)
cm_test_2
```

```{r}
stats_test_2 <- stats(cm_test_2)
stats_test_2
```

```{r}
stats_train_1 %>% 
  left_join(stats_train_2, by = "statistic", suffix = c(" model 1", " model 2"))
```

```{r}
stats_test_1 %>% 
  left_join(stats_test_2, by = "statistic", suffix = c(" model 1", " model 2"))
```

```{r}
classifier_1$aic
```

```{r}
classifier_2$aic
```
  
#ROC

```{r}
library(DALEX)
library(DALEX2)
```

```{r, warning=FALSE}
model2_exp <- explain(classifier_2, data = training_norm %>% select(-columns), label = "Model 2", y = prob_train_2)
variable_importance(model2_exp ) %>% plot()
```

```{r}
classifier_2 %>% summary
```

```{r}
training_norm %>% select(-columns) %>% colnames
```

```{r}
green_book <- tibble(Title = "Green Book", Year = 2018, Runtime = 130, Metacritic = 69, 
                     imdbRating = 8.3, RottenRating = 7.2, "Meter" = 92, 
                     userMeter = 79, userRating = 4.2, BoxOffice = 85080171, 
                     "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                     "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                     "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 3)
bohemian_rhapsody <- tibble(Title = "Bohemian Rhapsody", Year = 2018, Runtime = 134, Metacritic = 49, 
                            imdbRating = 8.1, RottenRating = 6.1, "Meter" = 86, 
                            userMeter = 78, userRating = 4.3, BoxOffice = 216428042, 
                            "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                            "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                            "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 4)

black_panther <- tibble(Title = "Black Panther", Year = 2018, Runtime = 134, Metacritic = 88, 
                        imdbRating = 7.3, RottenRating = 8.3, "Meter" = 79, 
                        userMeter = 65, userRating = 4.1, BoxOffice = 700059566, 
                        "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                        "Genre_Action" = 1, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                        "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 3)

BlacKkKlansman <- tibble(Title = "BlacKkKlansman", Year = 2018, Runtime = 128, Metacritic = 83, 
                         imdbRating = 7.5, RottenRating = 8.3, "Meter" = 82, 
                         userMeter = 74, userRating = 3.9, BoxOffice = 49275340, 
                         "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                         "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                         "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 1)

The_Favourite <- tibble(Title = "The Favourite", Year = 2018, Runtime = 119, Metacritic = 90, 
                        imdbRating = 7.6, RottenRating = 8.5, "Meter" = 67,
                        userMeter = 77, userRating = 3.5, BoxOffice = 34366783, 
                        "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                        "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                        "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 1)

star_is_born <- tibble(Title = "A Star is Born", Year = 2018, Runtime = 135, Metacritic = 88, 
                       imdbRating = 7.8, RottenRating = 8, "Meter" = 80, 
                       userMeter = 84, userRating = 4.1,BoxOffice = 215288866, 
                       "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
                       "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
                       "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 1)

roma <- tibble(Title = "Roma", Year = 2018, Runtime = 135, Metacritic = 96, 
               imdbRating = 7.8, RottenRating = 9, "Meter" = 71, 
               userMeter = 80, userRating = 3.7, BoxOffice = 4900000, 
               "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
               "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
               "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount = 3)

vice <- tibble(Title = "Vice", Year = 2018, Runtime = 132, Metacritic = 61, 
               imdbRating = 7.2, RottenRating = 6.7, "Meter" = 58, 
               userMeter = 80, userRating = 3.2, BoxOffice = 47836282, 
               "Audience_Not Rated" = 0, "Audience_PG" = 0, "Audience_G" = 0, 
               "Genre_Action" = 0, "Genre_Crime" = 0, "Genre_Documentary" = 0, 
               "Country_France" = 0, Oscar_2019 = 1, Oscar_2019_amount =3)

new_movies <- bind_rows(green_book, bohemian_rhapsody, black_panther, 
          BlacKkKlansman, The_Favourite, 
          star_is_born, roma, vice) %>% as_data_frame()

new_movies

```


```{r}
new_predictions <- function(data) {
  
  
  a <- data %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)
  
  b <- predict(normalization, a)
  
  c <- b %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),                                                                          starts_with("genre")), as.character)
  
  d <- c %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),                                                                          starts_with("genre")), as.numeric)
  
  e <- predict(classifier_2, newdata = d, type = "response")
  
  e
  
}
```


```{r}
new_movies %>% 
  mutate(Probability = new_predictions(new_movies),
         Oscar_prediction = ifelse(Probability >= .268, 1, 0)) %>% 
  select(Title, Probability, Oscar_prediction, Oscar_2019, Oscar_2019_amount) %>% 
  arrange(desc(Probability))
```





```{r}
green_book_norm <- predict(normalization, green_book %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)
bohemian_norm <- predict(normalization, bohemian_rhapsody %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)

black_panther_norm <- predict(normalization, black_panther %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)

BlacKkKlansman_norm <- predict(normalization, BlacKkKlansman %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)

favourite_norm <- predict(normalization, The_Favourite %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)

star_is_born_norm <- predict(normalization, star_is_born %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)
roma_norm <- predict(normalization, roma %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)

vice_norm <- predict(normalization, vice %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                 starts_with("genre")), as.factor)) %>% mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.character) %>% 
  mutate_at(vars(starts_with("country"), starts_with("audience"), starts_with("language"),
                                                                          starts_with("genre")), as.numeric)
  
```

```{r}
library(DALEX)
```

```{r}
explainer <- explain(classifier_2, data = training_norm, label = "Wpływ poszczególnych zmiennych na wynik predykcji.")
```

```{r}
new_pred <- prediction_breakdown(explainer, observation = black_panther_norm)
plot(new_pred)
```
```{r}
classifier_2$coefficient %>% length()
```

```{r}
suma <- c(classifier_2$coefficients[1])
for (i in 2:length(classifier_2$coefficients)) {
  
  beta <- classifier_2$coefficients[i]
  x <- bohemian_norm[i] %>% pull()
  odd <- beta*x
  suma <- c(suma, odd)
  
}


wyniki <- rownames_to_column(data.frame(suma), var = "var") %>% filter(suma != 0, var != "(Intercept)") %>% arrange(desc(suma))

wyniki$var <- factor(wyniki$var, levels = wyniki$var)
wyniki$id <- seq_along(wyniki$suma)
wyniki$type <- ifelse(wyniki$suma > 0, "+", "-")

wyniki$end <- cumsum(wyniki$suma) + classifier_2$coefficients[1]

wyniki$start <- c(classifier_2$coefficients[1], head(wyniki$end, -1))

wyniki %>% 
  # filter(var != "(Intercept)",
  #        suma != 0) %>%
  ggplot(aes(var, fill = type)) + geom_rect(aes(x = var, xmin = id - .45, xmax= id + .45, ymin = end, ymax = start)) + 
  geom_label(aes(label = round(suma,3), y = 5)) +
  scale_fill_manual(values = c("firebrick", "forestgreen")) +
  geom_text(aes(label = ifelse(var == wyniki$var[2], round(classifier_2$coefficients[1],3), ""), y = classifier_2$coefficients[1])) +
  geom_text(aes(label = ifelse(var == wyniki$var[length(wyniki$var) -1], round(wyniki$end[length(wyniki$end)],3), ""), y = wyniki$end[length(wyniki$end)])) +
  coord_flip() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue")) +
  labs(title = "Zmiana logitu w zależności od zmiennej",
       subtitle = "Dla filmu Bohemian Rhapsody",
       x = "Zmienna",
       y = "Wartość logitu",
       caption = "Źródło: opracowanie własne")
```